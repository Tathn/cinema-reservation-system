<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:sec="http://www.springframework.org/security/tags">
<h:head/>
<h:body>
<ui:composition template="/WEB-INF/template.xhtml">
	<f:metadata>
	  <f:viewAction action="#{screeningBean.redirectIfScreeningDataEmpty}" />
	</f:metadata>
	<ui:define name="content">
	<h:form id="buyTicketForm">
		<p:panel header="Book a ticket">
		
		<sec:authorize access="!isAuthenticated()">
		<div class="ui-messages ui-widget">
		<div class="ui-messages-warn ui-corner-all">
    		<span class="ui-messages-warn-icon"/>
    		<span class="ui-messages-warn-summary">You are not logged in.</span>
    		<span class="ui-messages-warn-detail">Please log in before booking a ticket.</span>
		</div>
		</div>
		</sec:authorize>
		
		<p:messages id="ticketMsg" showSummary="true" showDetail="true" showIcon="false"/>
		
		<p:panelGrid columns="2" layout="grid" columnClasses="ui-g-11 ui-g-1">
			<p:column>
			<p:panel header="Choose seat" id="chooseSeatPanel" >
				<div style="display: flex; justify-content: center; flex-wrap: wrap;
						background-color: gray; margin-bottom: 10px;">
					<p style="margin: 5px;">Screen</p>
				</div>
				<div id="seatsWrapper" style="display: flex; justify-content: center; flex-wrap: wrap;">
					<p:repeat var="seat" varStatus="seatStatus" value="#{screeningBean.selectedScreeningSeats}">
						<div style="display: block; text-align:center; margin 5px; font-size: 12px;">
							
							<p:commandLink action="#{screeningBean.selectDeselectSeat}" update=" :buyTicketForm:choosenSeats,@this"  rendered="#{seat.availability}">
	             					<f:param name="seat_id" value="#{seat.id}" />
			                	<p:graphicImage name="images/seat_available.png" width="30px" rendered="#{!screeningBean.isSeatOnTicket(seat)}" />
			           			<p:graphicImage name="images/seat_choosen.png" width="30px"  rendered="#{screeningBean.isSeatOnTicket(seat)}" />
			           		</p:commandLink>
			                <p:graphicImage name="images/seat_not_available.png" width="30px" rendered="#{!seat.availability}"/>
			           		
			           		<br />
			           		<h:outputText value="#{seat.label}"/>
		           		</div>
		           		<ui:fragment rendered="#{(seatStatus.index + 1) % screeningBean.selectedScreening.room.columns == 0}">
							<div style="flex-basis: 100%; margin-bottom:5px;" />
						</ui:fragment>
					</p:repeat>
				</div>
			</p:panel>
			</p:column>
			<p:column>
			<p:panel header="Ticket" id="ticketSummaryPanel">
				<h:outputText value="#{screeningBean.selectedScreening.movie.title}"/>
				<br />
				<h:outputText value="#{screeningBean.selectedScreening.startsAt}">
					<f:convertDateTime pattern="HH:mm"/>
				</h:outputText>
				<h:outputText value=" - "/>
				<h:outputText value="#{screeningBean.selectedScreening.finishesAt}">
					<f:convertDateTime pattern="HH:mm"/>
				</h:outputText>
				<br />
				<h:outputText value="Choosen seats:" />
				<p:dataGrid id="choosenSeats" var="seat" value="#{screeningBean.ticket.screeningSeats}"
					emptyMessage="No seats choosen" columns="4" layout="grid">
					<p:graphicImage name="images/seat_choosen.png" width="30px"  />
					<h:outputText value="#{seat.label}"/>
				</p:dataGrid>
				<p:commandButton value="Book ticket" update="@all" action="#{screeningBean.bookTicket}"/>
			</p:panel>
			</p:column>
		</p:panelGrid>
		</p:panel>
	</h:form>
	</ui:define>
</ui:composition>
</h:body>
</html>